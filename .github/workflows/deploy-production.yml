# =============================================================================
# Production Deployment Workflow (Railway API Only)
# =============================================================================
# Triggers: Push to main (after CI passes), manual dispatch
# Target: Railway production environment
#
# NOTE: Vercel handles web deployments automatically (Production on main merge).
#       This workflow only deploys the API to Railway production.
# =============================================================================
#
# SECRETS REQUIRED (configure in GitHub Settings ‚Üí Environments ‚Üí production):
#   RAILWAY_TOKEN       - Railway API token (Dashboard ‚Üí Account ‚Üí Tokens)
#
# ENVIRONMENT VARIABLES (configure in GitHub Settings ‚Üí Environments ‚Üí production):
#   PRODUCTION_API_URL  - Railway production server URL (e.g., https://nx-monoreposerver-production.up.railway.app)
#
# =============================================================================

name: Deploy to Production (Railway)

on:
  # Trigger after CI workflow completes successfully on main
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

  # Allow manual deployment trigger
  workflow_dispatch:
    inputs:
      skip_health_check:
        description: 'Skip health check verification'
        required: false
        default: false
        type: boolean

# Ensure only one production deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

# Required permissions for deployment status updates
permissions:
  contents: read
  deployments: write
  statuses: write

jobs:
  # ==========================================================================
  # Gate: Only deploy if CI passed (for workflow_run trigger)
  # ==========================================================================
  check-ci:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI result
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Manual trigger - proceeding with production deployment"
          elif [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ CI passed - proceeding with production deployment"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "‚ùå CI did not pass (conclusion: ${{ github.event.workflow_run.conclusion }}) - skipping deployment"
          fi

  # ==========================================================================
  # Deploy API Server to Railway Production
  # ==========================================================================
  deploy-api:
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.get-url.outputs.url }}
    outputs:
      url: ${{ steps.get-url.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Production
        run: |
          echo "üöÄ Deploying to Railway production environment..."
          railway up --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Get Deployment URL
        id: get-url
        run: |
          # Use configured production URL from environment variables
          RAILWAY_URL="${{ vars.PRODUCTION_API_URL }}"

          if [ -z "$RAILWAY_URL" ]; then
            echo "‚ùå ERROR: PRODUCTION_API_URL not configured in GitHub environment"
            echo "Please configure PRODUCTION_API_URL in GitHub Settings ‚Üí Environments ‚Üí production ‚Üí Variables"
            echo "Expected format: https://nx-monoreposerver-production.up.railway.app"
            exit 1
          fi

          echo "url=$RAILWAY_URL" >> $GITHUB_OUTPUT
          echo "üìç Production API URL: $RAILWAY_URL"

      - name: Wait for Railway Deployment
        run: |
          echo "‚è≥ Waiting 90s for Railway deployment to complete..."
          sleep 90

      - name: Verify API Health Check
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_health_check != 'true' }}
        run: |
          API_URL="${{ steps.get-url.outputs.url }}"
          HEALTH_URL="${API_URL}/api/health"
          echo "üîç Checking health at: $HEALTH_URL"

          # Retry up to 5 times with 15s between attempts (Railway cold starts can be slower)
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            RESPONSE=$(curl -s "$HEALTH_URL" || echo "{}")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Production API health check passed (attempt $i)"
              echo "üìä Response: $RESPONSE"
              exit 0
            fi
            echo "‚è≥ Attempt $i: HTTP $HTTP_STATUS - retrying in 15s..."
            sleep 15
          done

          echo "‚ùå Production API health check failed after 5 attempts"
          exit 1

  # ==========================================================================
  # Post-Deployment Summary
  # ==========================================================================
  deployment-summary:
    needs: [check-ci, deploy-api]
    if: always() && needs.check-ci.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "# üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|" >> $GITHUB_STEP_SUMMARY

          # Web status (Vercel auto-deploys on main)
          echo "| Web (Vercel) | ‚úÖ Auto-deployed | See Vercel dashboard |" >> $GITHUB_STEP_SUMMARY

          # API status
          if [ "${{ needs.deploy-api.result }}" = "success" ]; then
            echo "| API (Railway) | ‚úÖ Success | ${{ needs.deploy-api.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API (Railway) | ‚ùå Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Web deployments are handled by Vercel automatically on merge to main._" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        if: needs.deploy-api.result != 'success'
        run: |
          echo "‚ùå Production deployment failed"
          exit 1

