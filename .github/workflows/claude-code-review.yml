name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            **First**: Read CLAUDE.md thoroughly to understand project context, architecture, and current phase. Follow documentation references within CLAUDE.md, especially:
            - docs/P1-plan.md (current implementation stage and progress)
            - docs/memories/adopted-patterns.md (established patterns that prevent drift)
            - docs/memories/tech-findings-log.md (technical decisions and constraints)

            **Note**: Ignore `Modified:` and `Created:` timestamp changes in `docs/` frontmatter - these are automatically managed by Git tooling and are expected.

            **Review priorities**:
            1. **Architectural Adherence**: Verify against monorepo structure, dependency flow, and architectural blueprints in CLAUDE.md
            2. **Pattern Consistency**: Flag divergent implementation approaches across components, even when both are technically correct
            3. **Code Quality**: Bugs, security vulnerabilities, performance issues
            4. **Best Practices**: Test coverage, type safety, proper imports, test file location
            5. **Standards & Regressions**: Note if code falls below project standards or contradicts documented decisions

            Be constructive and specific. Acknowledge strengths concisely and in measured terms, focus review time on issues and improvements. Avoid nit-picking or preemptively propose improvements that are likely to be part of work planned later.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
