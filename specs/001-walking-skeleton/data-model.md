# Data Model: Walking Skeleton Health Check

**Feature**: Walking Skeleton Health Check
**Created**: 2025-10-30
**Purpose**: Minimal data model to validate end-to-end persistence from Prisma to Supabase

---

## Overview

This data model is intentionally minimal to serve as infrastructure validation only. The single `HealthCheck` entity exercises database schema definition, ORM code generation, and persistence without introducing domain complexity.

**Throwaway Code**: All entities defined here are marked for deletion once infrastructure validation is complete.

---

## Entities

### HealthCheck

**Purpose**: Represents a single health check record to prove database persistence works correctly.

**Storage**: PostgreSQL table `health_checks` (snake_case plural) in Supabase database, accessed via Prisma ORM.

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID | Primary key, auto-generated | Unique identifier for the health check record |
| `message` | String | Optional, default: "Health check ping" | Descriptive message for the health check event |
| `timestamp` | DateTime | Required, auto-generated, timezone-aware | When the health check was created (PostgreSQL `timestamptz`) |

**Prisma Schema Representation**:
```prisma
model HealthCheck {
  id        String   @id @default(uuid()) @db.Uuid
  message   String   @default("Health check ping")
  timestamp DateTime @default(now()) @db.Timestamptz

  @@map("health_checks")
}
```

**Validation Rules**:
- **id**: Generated client-side by Prisma using `uuid()` function, validated as PostgreSQL UUID type
- **message**: Optional string, defaults to "Health check ping" if not provided, no maximum length constraint (Phase 1 simplification)
- **timestamp**: Auto-generated on insert using `now()`, immutable after creation, stores timezone information (UTC)

**State Transitions**: None - health checks are immutable once created (no updates or state changes).

**Relationships**: None - this is an isolated entity for infrastructure validation.

---

## Database Schema

**Migration Strategy**: Prisma migrations applied to Supabase PostgreSQL database.

**Migration File**: `packages/database/prisma/migrations/YYYYMMDDHHMMSS_create_health_checks/migration.sql`

**Migration SQL** (will be generated by Prisma):
```sql
CREATE TABLE "health_checks" (
  "id" UUID NOT NULL DEFAULT gen_random_uuid(),
  "message" TEXT NOT NULL DEFAULT 'Health check ping',
  "timestamp" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT "health_checks_pkey" PRIMARY KEY ("id")
);

-- RLS Strategy: Enable for defense-in-depth (API server uses service_role key to bypass)
ALTER TABLE "health_checks" ENABLE ROW LEVEL SECURITY;
```

**Connection Strategy** (per research findings):
- Prisma connects via Supavisor connection pooler
- Transaction mode (port 6543) for queries
- Session mode (port 5432) for migrations via `directUrl` configuration

**RLS Policy** (per research findings):
- RLS enabled on table (not disabled)
- API path: service_role bypass via PostgREST when needed
- Prisma: bypass via SQL database role (superuser in Phase 1)
- Defense-in-depth strategy (protects against accidental API exposure)

---

## Domain Rules

Since this is throwaway validation code, domain rules are minimal:

1. **Creation**: Health checks can only be created, never updated or deleted
2. **Message content**: No validation or sanitization (Phase 1 simplification)
3. **Timestamp immutability**: Timestamp cannot be modified after creation
4. **No soft deletes**: Records are permanent for infrastructure testing

---

## Query Patterns

**Expected Query Operations** (implemented in `packages/database/src/health.ts`):

### 1. List All Health Checks
```typescript
getHealthChecks(): Promise<HealthCheck[]>
```
- Retrieves all health check records ordered by timestamp descending
- No pagination (Phase 1 simplification)
- Used by: GET /api/health HTTP endpoint (OpenAPI path: `/health` with `servers: [{ url: '/api' }]`)

### 2. Create Health Check
```typescript
createHealthCheck(message?: string): Promise<HealthCheck>
```
- Creates new health check with optional custom message
- Defaults to "Health check ping" if message not provided
- Used by: POST /api/health/ping HTTP endpoint (OpenAPI path: `/health/ping` with `servers: [{ url: '/api' }]`)

**No other operations**: No updates, deletes, or individual record retrieval needed for walking skeleton.

---

## Type Safety Flow

**Database → TypeScript Type Chain**:

1. **Prisma Schema** (`schema.prisma`) defines database schema
2. **Prisma Client** generates TypeScript types automatically
3. **Zod Schemas** (`@nx-monorepo/schemas`) define validation and runtime types
4. **OpenAPI Spec** (`apps/server`) generates from Zod schemas via `@asteasolutions/zod-to-openapi`
5. **API Client Types** (`@nx-monorepo/api-client`) generated from OpenAPI spec via `openapi-typescript`
6. **Web UI** consumes API client types for full end-to-end type safety

This chain validates that type definitions flow correctly through all layers without manual type casting or duplication.

---

## Infrastructure Validation Goals

This data model proves:
- ✅ Prisma schema compiles and generates correct TypeScript types
- ✅ Migrations apply successfully to Supabase PostgreSQL
- ✅ Prisma Client connects to Supabase via Supavisor pooler
- ✅ UUID generation works client-side with PostgreSQL type validation
- ✅ Timestamp handling is timezone-aware and DST-safe
- ✅ RLS is enabled with service_role bypass working correctly
- ✅ Database queries return correctly typed results to application layers

---

## Future Cleanup

**Deletion Checklist** (execute after infrastructure validation complete):
- [ ] Delete `packages/database/prisma/migrations/*_create_health_checks/` directory
- [ ] Remove `HealthCheck` model from `packages/database/prisma/schema.prisma`
- [ ] Delete `packages/database/src/health.ts` and `health.spec.ts`
- [ ] Drop `health_checks` table from Supabase database manually (Prisma doesn't auto-drop)
- [ ] Remove health check schemas from `packages/schemas/src/health.schema.ts`
- [ ] Delete health check routes from `apps/server/src/routes/health.routes.ts`
- [ ] Remove `/health` page from `apps/web/src/app/health/`

**Verification**: After cleanup, run `pnpm exec nx run-many -t lint test build` to ensure no broken imports remain.
