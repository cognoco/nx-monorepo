<story-context id="5b-2-execute-migrations-and-update-nx-plugins" v="1.0">
  <metadata>
    <epicId>5b</epicId>
    <storyId>2</storyId>
    <title>Execute Migrations and Update All @nx/* Plugins</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5b-2-execute-migrations-and-update-nx-plugins.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps engineer</asA>
    <iWant>all @nx/* plugins updated to match Nx 22.2.0</iWant>
    <soThat>the workspace has consistent tooling versions</soThat>
    <tasks>
      <task id="1" acs="1">Review migrations.json from 5b.1 - understand which migrations will run</task>
      <task id="2" acs="2">Install updated dependencies - pnpm install</task>
      <task id="3" acs="3">Execute migrations - pnpm exec nx migrate --run-migrations</task>
      <task id="4" acs="4">Verify @nx/* version alignment - check all packages match</task>
      <task id="5" acs="3">Clean up - delete migrations.json after successful run</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">All @nx/* packages updated to 22.2.0+ in package.json</criterion>
    <criterion id="2">pnpm install completes without errors</criterion>
    <criterion id="3">pnpm exec nx migrate --run-migrations completes successfully</criterion>
    <criterion id="4">Version pinning policy maintained - all @nx/* versions match</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/epic-5b-nx-upgrade-analysis.md</path>
        <title>Epic 5b Nx Upgrade Analysis</title>
        <section>Nx Plugin Compatibility, Affected Packages</section>
        <snippet>Lists all @nx/* packages that must upgrade together. Documents version alignment strategy.</snippet>
      </doc>
      <doc>
        <path>docs/tech-stack.md</path>
        <title>Technology Stack Reference</title>
        <section>Version Pinning Policy</section>
        <snippet>Critical Rule: All @nx/* packages must match core nx version.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>package.json</path>
        <kind>manifest</kind>
        <symbol>dependencies, devDependencies</symbol>
        <reason>Primary file to modify - all @nx/* versions will be updated</reason>
      </file>
      <file>
        <path>migrations.json</path>
        <kind>migration-plan</kind>
        <symbol>Nx migration plan</symbol>
        <reason>Generated by Story 5b.1, contains list of migrations to execute</reason>
      </file>
      <file>
        <path>nx.json</path>
        <kind>workspace-config</kind>
        <symbol>Nx workspace configuration</symbol>
        <reason>May be modified by migrations</reason>
      </file>
      <file>
        <path>apps/web/project.json</path>
        <kind>project-config</kind>
        <symbol>Web app project configuration</symbol>
        <reason>May be modified by migrations</reason>
      </file>
      <file>
        <path>apps/server/project.json</path>
        <kind>project-config</kind>
        <symbol>Server project configuration</symbol>
        <reason>May be modified by migrations</reason>
      </file>
    </code>

    <dependencies>
      <ecosystem name="nx-packages">
        <package name="nx" version="22.2.0+" />
        <package name="@nx/devkit" version="22.2.0+" />
        <package name="@nx/esbuild" version="22.2.0+" />
        <package name="@nx/eslint" version="22.2.0+" />
        <package name="@nx/eslint-plugin" version="22.2.0+" />
        <package name="@nx/jest" version="22.2.0+" />
        <package name="@nx/js" version="22.2.0+" />
        <package name="@nx/next" version="22.2.0+" />
        <package name="@nx/node" version="22.2.0+" />
        <package name="@nx/playwright" version="22.2.0+" />
        <package name="@nx/react" version="22.2.0+" />
        <package name="@nx/workspace" version="22.2.0+" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="version-match">All @nx/* packages MUST match the core nx version exactly</constraint>
    <constraint type="command">Use pnpm exec nx commands, never npm or yarn</constraint>
    <constraint type="process">Run migrations AFTER pnpm install, not before</constraint>
    <constraint type="cleanup">Delete migrations.json after successful migration run</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Nx Run Migrations</name>
      <kind>CLI command</kind>
      <signature>pnpm exec nx migrate --run-migrations</signature>
      <path>node_modules/nx/bin/nx.js</path>
    </interface>
    <interface>
      <name>pnpm install</name>
      <kind>CLI command</kind>
      <signature>pnpm install</signature>
      <path>N/A</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Infrastructure story - no unit tests. Validation is via version verification.
    </standards>
    <locations>
      <location>N/A - infrastructure story</location>
    </locations>
    <ideas>
      <idea ac="1,4">Verify all @nx/* versions match: grep "@nx/" package.json</idea>
      <idea ac="2">Verify no peer dependency errors in pnpm install output</idea>
      <idea ac="3">Verify migrations.json deleted after successful run</idea>
    </ideas>
  </tests>
</story-context>
