<story-context v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>1</storyId>
    <title>Create Server Auth Middleware Structure</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-1-create-server-auth-middleware-structure.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>auth middleware patterns in the Express server</iWant>
    <soThat>I can easily protect API endpoints in Phase 2</soThat>
    <tasks>
      <task id="1">Create middleware directory structure (auth.ts, index.ts barrel)</task>
      <task id="2">Implement JWT extraction from Authorization header</task>
      <task id="3">Implement token validation with Supabase admin client</task>
      <task id="4">Implement request context attachment (AuthenticatedRequest interface)</task>
      <task id="5">Create requireAuth middleware function</task>
      <task id="6">Add comprehensive JSDoc documentation</task>
      <task id="7">Write unit tests for middleware</task>
      <task id="8">Verify middleware is NOT applied to routes yet</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Create middleware in apps/server/src/middleware/ with reusable functions for: extracting JWT, validating token, attaching user context</criterion>
    <criterion id="AC2">Middleware is documented with JSDoc comments and usage examples</criterion>
    <criterion id="AC3">Middleware is NOT applied to any routes (prepared for Phase 2 only)</criterion>
    <criterion id="AC4">Export requireAuth middleware function from barrel file</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Express API server is the security boundary. All authentication validation happens here before data access. RLS enabled with service_role bypass.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>PRD</title>
        <section>FR10</section>
        <snippet>Supabase client factories must support browser and server contexts with appropriate key usage and security boundaries.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Epic 4: Authentication Infrastructure Wiring</section>
        <snippet>Authentication infrastructure in place and ready for application-level implementation in Phase 2.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>apps/server/src/middleware/validate.middleware.ts</path>
        <kind>middleware</kind>
        <symbol>validateBody, validateQuery, validateParams</symbol>
        <reason>Existing middleware pattern to follow - Express middleware factory pattern with error handling</reason>
      </file>
      <file>
        <path>apps/server/src/app.ts</path>
        <kind>application</kind>
        <symbol>createApp</symbol>
        <reason>Shows middleware ordering and where auth middleware would eventually be added</reason>
      </file>
      <file>
        <path>packages/supabase-client/src/lib/client.ts</path>
        <kind>library</kind>
        <symbol>createSupabaseBrowserClient, createSupabaseServerClient</symbol>
        <reason>Existing Supabase client factories - NOTE: These are for Next.js, not Express. Auth middleware needs direct Supabase admin client.</reason>
      </file>
      <file>
        <path>apps/server/src/main.ts</path>
        <kind>entry</kind>
        <symbol>main</symbol>
        <reason>Shows environment loading pattern and app initialization</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package name="express" version="^4.21.2" />
        <package name="@supabase/supabase-js" note="Install for admin client: pnpm add @supabase/supabase-js --filter @nx-monorepo/server" />
        <package name="zod" note="For input validation if needed" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow existing middleware pattern in validate.middleware.ts</constraint>
    <constraint>Use Supabase admin client (service_role key) for server-side token validation</constraint>
    <constraint>Return 401 Unauthorized for invalid/missing authentication</constraint>
    <constraint>Error responses must follow RFC 7807 Problem Details pattern</constraint>
    <constraint>TypeScript strict mode - no 'as' casting</constraint>
    <constraint>Co-located tests next to source files (auth.spec.ts)</constraint>
    <constraint>Do NOT apply middleware to routes - infrastructure only</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AuthenticatedRequest</name>
      <kind>TypeScript interface</kind>
      <signature>interface AuthenticatedRequest extends Request { user?: { id: string; email?: string; [key: string]: unknown } }</signature>
      <path>apps/server/src/middleware/auth.ts</path>
    </interface>
    <interface>
      <name>requireAuth</name>
      <kind>Express middleware</kind>
      <signature>(req: Request, res: Response, next: NextFunction) => Promise&lt;void&gt;</signature>
      <path>apps/server/src/middleware/auth.ts</path>
    </interface>
    <interface>
      <name>Supabase getUser</name>
      <kind>External API</kind>
      <signature>supabase.auth.getUser(jwt: string): Promise&lt;{ data: { user: User | null }, error: AuthError | null }&gt;</signature>
      <path>@supabase/supabase-js</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Jest 30 for unit testing. Co-located tests in src/ directory. Mock external dependencies (Supabase client). Follow existing test patterns in validate.middleware.ts if tests exist.</standards>
    <locations>
      <location>apps/server/src/middleware/auth.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test JWT extraction: valid token, missing header, malformed header (no Bearer prefix)</idea>
      <idea ac="AC1">Test token validation: valid token returns user, invalid token returns null, expired token handled</idea>
      <idea ac="AC1">Test user context attachment: user object attached to req.user on success</idea>
      <idea ac="AC4">Test requireAuth integration: 401 on missing auth, 401 on invalid token, next() on valid auth</idea>
    </ideas>
  </tests>
</story-context>

