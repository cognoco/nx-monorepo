<story-context v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Create Web Auth State Management Patterns</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-3-create-web-auth-state-management-patterns.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>frontend developer</asA>
    <iWant>auth state management patterns for Next.js</iWant>
    <soThat>I have a foundation for building auth UI in Phase 2</soThat>
    <tasks>
      <task id="1">Create auth utilities directory (apps/web/src/lib/auth.ts)</task>
      <task id="2">Implement session retrieval patterns for Server Components</task>
      <task id="3">Implement auth state subscription pattern for Client Components</task>
      <task id="4">Create route protection middleware pattern (disabled)</task>
      <task id="5">Document Server Component auth patterns</task>
      <task id="6">Document Route Handler auth patterns</task>
      <task id="7">Ensure patterns are NOT wired to routes</task>
      <task id="8">Write documentation for patterns</task>
      <task id="9">Write unit tests for utilities</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Documented patterns for getting current session/user in apps/web</criterion>
    <criterion id="AC2">Documented patterns for subscribing to auth state changes</criterion>
    <criterion id="AC3">Documented patterns for protecting routes with Next.js middleware</criterion>
    <criterion id="AC4">Patterns documented but NOT wired into routes; example code exists but is not active</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Technology Stack Details</section>
        <snippet>Web: Next.js 15.2 + React 19. Server components, streaming, App Router.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns - Lifecycle</section>
        <snippet>Loading: React Server Components + Suspense. Mutations: useTransition or useOptimistic.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>PRD</title>
        <section>FR10</section>
        <snippet>Supabase client factories must support browser and server contexts.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>packages/supabase-client/src/lib/client.ts</path>
        <kind>library</kind>
        <symbol>createSupabaseBrowserClient, createSupabaseServerClient</symbol>
        <reason>Existing client factories to use in auth utilities</reason>
      </file>
      <file>
        <path>apps/web/src/app/layout.tsx</path>
        <kind>component</kind>
        <symbol>RootLayout</symbol>
        <reason>Root layout where auth provider could be added in Phase 2</reason>
      </file>
      <file>
        <path>apps/web/src/app/page.tsx</path>
        <kind>component</kind>
        <symbol>Index</symbol>
        <reason>Example Server Component structure</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package name="next" version="~15.2.4" />
        <package name="react" version="19.0.0" />
        <package name="@supabase/ssr" note="Already installed via supabase-client package" />
        <package name="@nx-monorepo/supabase-client" note="Workspace package" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use existing supabase-client factories - do NOT duplicate</constraint>
    <constraint>Next.js 15 App Router patterns (not Pages Router)</constraint>
    <constraint>Server Components are the default - use 'use client' only when needed</constraint>
    <constraint>Middleware matcher should be empty (disabled for Phase 1)</constraint>
    <constraint>TypeScript strict mode</constraint>
    <constraint>Co-located tests in src/lib/auth.spec.ts</constraint>
    <constraint>Patterns are DOCUMENTATION with example code - NOT active implementation</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>getSession</name>
      <kind>Server utility function</kind>
      <signature>async function getSession(): Promise&lt;Session | null&gt;</signature>
      <path>apps/web/src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>getUser</name>
      <kind>Server utility function</kind>
      <signature>async function getUser(): Promise&lt;User | null&gt;</signature>
      <path>apps/web/src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>useAuthStateChange</name>
      <kind>React hook pattern</kind>
      <signature>function useAuthStateChange(): { user: User | null; loading: boolean; error: Error | null }</signature>
      <path>apps/web/src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>Next.js Middleware</name>
      <kind>Middleware pattern</kind>
      <signature>export function middleware(request: NextRequest): NextResponse</signature>
      <path>apps/web/src/middleware.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Jest 30 for unit testing. Mock Supabase client. Test utility functions in isolation. Integration tests not required for patterns.</standards>
    <locations>
      <location>apps/web/src/lib/auth.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test getSession: returns session when authenticated, returns null when not</idea>
      <idea ac="AC1">Test getUser: returns user object, handles null session</idea>
      <idea ac="AC2">Test useAuthStateChange hook: initial loading state, state updates on auth change</idea>
      <idea ac="AC3">Test middleware pattern: verifies disabled matcher config</idea>
    </ideas>
  </tests>
</story-context>

