<story-context id="6-1-generate-expo-mobile-application" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>Generate Expo Mobile Application</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-1-generate-expo-mobile-application.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>mobile developer</asA>
    <iWant>an Expo mobile app in the monorepo</iWant>
    <soThat>I can build cross-platform mobile experiences</soThat>
    <tasks>
      <task id="1" acs="1,5">Verify Nx Plugin Compatibility - Check @nx/expo version in Nx 21.6.5, verify SDK 53 support</task>
      <task id="2" acs="1,2">Generate Mobile Application - Primary: nx g @nx/expo:app OR fallback: create-expo-app</task>
      <task id="3" acs="1,6">Configure for Expo SDK 53 - expo ~53.0.0, react 19.0.0, react-native ~0.79.0</task>
      <task id="4" acs="7">Configure Metro for Monorepo - watchFolders + nodeModulesPaths</task>
      <task id="5" acs="1,3,4">Follow Post-Generation Checklist</task>
      <task id="6" acs="2,3,4">Verify All Nx Targets - start, lint, test</task>
      <task id="7" acs="1">Validate No Duplicate Dependencies - pnpm why react/react-native</task>
      <task id="8" acs="3,4">Update CI Workflow if needed</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">App generated with correct structure via nx g @nx/expo:app or fallback</criterion>
    <criterion id="2">pnpm exec nx run mobile:start launches Expo dev server with QR code</criterion>
    <criterion id="3">pnpm exec nx run mobile:lint passes with no errors</criterion>
    <criterion id="4">pnpm exec nx run mobile:test passes default tests</criterion>
    <criterion id="5">Fallback approach works if @nx/expo doesn't support SDK 53</criterion>
    <criterion id="6">Routes in app/ directory following Expo Router file-based routing</criterion>
    <criterion id="7">metro.config.js includes watchFolders and nodeModulesPaths for monorepo</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/epic-6-design-decisions.md</path>
        <title>Epic 6 Design Decisions</title>
        <section>D1-D4: SDK Version, Navigation, Nx Generation, Metro Config</section>
        <snippet>Use Expo SDK 53 (React 19.0.0 matches web), Expo Router for navigation, @nx/expo:app with fallback, Metro monorepo config</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>AC-6.1, Project Structure, Dependencies</section>
        <snippet>Mobile app structure with app/ for Expo Router routes, src/ for components, metro.config.js for bundler</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure, Dependency Flow</section>
        <snippet>apps/mobile will integrate into existing dependency graph: mobile → api-client → schemas</snippet>
      </doc>
      <doc>
        <path>docs/tech-stack.md</path>
        <title>Technology Stack Reference</title>
        <section>Core Stack, Version Pinning</section>
        <snippet>React 19.0.0 exact pin, Nx 21.6.5, TypeScript ~5.9.2 - mobile must match these</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>apps/web/project.json</path>
        <kind>project-config</kind>
        <symbol>web project configuration</symbol>
        <reason>Reference for Nx project structure - mobile project.json should follow similar pattern</reason>
      </file>
      <file>
        <path>apps/web/jest.config.ts</path>
        <kind>test-config</kind>
        <symbol>Jest configuration</symbol>
        <reason>Reference for mobile Jest configuration pattern</reason>
      </file>
      <file>
        <path>apps/web/tsconfig.json</path>
        <kind>typescript-config</kind>
        <symbol>TypeScript configuration</symbol>
        <reason>Reference for mobile TypeScript extends pattern</reason>
      </file>
      <file>
        <path>nx.json</path>
        <kind>workspace-config</kind>
        <symbol>Nx workspace configuration</symbol>
        <reason>May need @nx/expo plugin added; contains target defaults</reason>
      </file>
      <file>
        <path>tsconfig.base.json</path>
        <kind>typescript-config</kind>
        <symbol>Base TypeScript configuration</symbol>
        <reason>Mobile tsconfig should extend this; path aliases defined here</reason>
      </file>
      <file>
        <path>.github/workflows/ci.yml</path>
        <kind>ci-config</kind>
        <symbol>CI workflow</symbol>
        <lines>82</lines>
        <reason>May need mobile:lint and mobile:test added to run-many command</reason>
      </file>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="nx" version="21.6.5" />
        <package name="@nx/devkit" version="21.6.5" />
        <package name="react" version="19.0.0" required="MUST match exactly" />
        <package name="typescript" version="~5.9.2" />
        <package name="jest" version="30.2.0" />
        <package name="@swc/jest" version="~0.2.38" />
      </ecosystem>
      <ecosystem name="expo-to-add">
        <package name="expo" version="~53.0.0" note="SDK 53 stable" />
        <package name="react-native" version="~0.79.0" note="Ships with SDK 53" />
        <package name="expo-router" version="~4.0.0" note="File-based routing" />
        <package name="expo-constants" version="latest" note="For environment config" />
      </ecosystem>
      <ecosystem name="nx-plugin-to-add">
        <package name="@nx/expo" version="21.6.5" note="Verify SDK 53 support" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="version-match">React version MUST be 19.0.0 to match web app - prevents duplicate React errors in monorepo</constraint>
    <constraint type="version-match">All @nx/* packages MUST be 21.6.5 to match workspace</constraint>
    <constraint type="architecture">Mobile app follows unidirectional dependencies: apps/mobile → packages/api-client → packages/schemas</constraint>
    <constraint type="architecture">No app-to-app imports - mobile cannot import from apps/web</constraint>
    <constraint type="pattern">Use Expo Router (file-based routing) - routes in app/ directory</constraint>
    <constraint type="pattern">Walking skeleton: use out-of-box scaffolding only, no custom navigation patterns</constraint>
    <constraint type="bundler">Metro config must include monorepo support: watchFolders, nodeModulesPaths</constraint>
    <constraint type="testing">Co-locate tests in src/ next to source files (.spec.tsx pattern)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Nx Expo Generator</name>
      <kind>CLI command</kind>
      <signature>pnpm exec nx g @nx/expo:app mobile --directory=apps/mobile</signature>
      <path>node_modules/@nx/expo/src/generators/application</path>
    </interface>
    <interface>
      <name>Expo Router Layout</name>
      <kind>React component</kind>
      <signature>export default function RootLayout() { return &lt;Stack /&gt;; }</signature>
      <path>apps/mobile/app/_layout.tsx (to be created)</path>
    </interface>
    <interface>
      <name>Metro Config Monorepo</name>
      <kind>configuration</kind>
      <signature>config.watchFolders = [monorepoRoot]; config.resolver.nodeModulesPaths = [...];</signature>
      <path>apps/mobile/metro.config.js (to be created)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Jest 30.2.0 with @swc/jest transformer. Co-locate test files next to source files using .spec.tsx pattern. 
      Mobile tests should follow same patterns as apps/web. Use jest-environment-jsdom for React Native component tests.
      Run tests via: pnpm exec nx run mobile:test
    </standards>
    <locations>
      <location>apps/mobile/src/**/*.spec.tsx</location>
      <location>apps/mobile/src/**/*.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="1,2">Verify app structure created with expected files (app/, src/, project.json)</idea>
      <idea ac="3">Verify linting configuration works with Expo/React Native code</idea>
      <idea ac="4">Default generated tests pass without modification</idea>
      <idea ac="6">Verify Expo Router _layout.tsx and index.tsx exist in app/ directory</idea>
      <idea ac="7">Verify Metro resolves workspace packages correctly</idea>
    </ideas>
  </tests>
</story-context>


