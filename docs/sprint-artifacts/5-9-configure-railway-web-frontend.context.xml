<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context Document
  Generated: 2025-12-09
  Story: 5-9-configure-railway-web-frontend
  Epic: 5 - CI/CD Staging & Production Deployment
-->
<story-context story-id="5-9" version="1.0">
  <metadata>
    <title>Configure Railway Web Frontend</title>
    <epic>Epic 5: CI/CD Staging & Production Deployment</epic>
    <status>approved</status>
    <generated-date>2025-12-09</generated-date>
    <dependencies>
      <dependency story-id="5-8" status="done">Validate Production Deployment</dependency>
      <dependency story-id="5-3" status="done">Configure Docker Containerization (web Dockerfile)</dependency>
    </dependencies>
  </metadata>

  <story-summary>
    <user-story>
      As a DevOps engineer, I want the web frontend deployed to Railway,
      so that we demonstrate dual frontend architecture with deployment portability.
    </user-story>
    <acceptance-criteria>
      <criterion id="AC1">Railway web service uses apps/web/Dockerfile, env vars point to same backend, CORS accepts both origins</criterion>
      <criterion id="AC2">Both frontends (Vercel + Railway) can access the same API</criterion>
      <criterion id="AC3">Deployment workflow includes Railway web deployment</criterion>
    </acceptance-criteria>
  </story-summary>

  <architectural-context>
    <dual-frontend-architecture>
      <diagram>
        ┌────────────────────┐     ┌────────────────────┐
        │  Vercel Frontend   │     │  Railway Frontend  │
        │  (auto-deploy)     │     │  (controlled)      │
        │  Vercel builder    │     │  Docker container  │
        └─────────┬──────────┘     └─────────┬──────────┘
                  │                          │
                  │    Same BACKEND_URL      │
                  └────────────┬─────────────┘
                               ▼
                    ┌──────────────────┐
                    │  Railway Backend │
                    │  (single instance)│
                    └────────┬─────────┘
                             ▼
                    ┌──────────────────┐
                    │ Supabase STAGING │
                    └──────────────────┘
      </diagram>
      <key-insight>Same application code, different build systems (Vercel native vs Docker)</key-insight>
      <purpose>Demonstrates deployment portability (PRD FR19)</purpose>
    </dual-frontend-architecture>

    <build-comparison>
      <platform name="Vercel" uses-dockerfile="false">Vercel's native Next.js builder</platform>
      <platform name="Railway" uses-dockerfile="true">apps/web/Dockerfile</platform>
    </build-comparison>
  </architectural-context>

  <technical-specifications>
    <railway-web-service>
      <dockerfile>apps/web/Dockerfile</dockerfile>
      <build-context>monorepo root</build-context>
      <health-check>/health</health-check>
    </railway-web-service>

    <environment-variables>
      <variable name="NEXT_PUBLIC_SUPABASE_URL">https://uvhnqtzufwvaqvbdgcnn.supabase.co</variable>
      <variable name="NEXT_PUBLIC_SUPABASE_ANON_KEY">eyJ...</variable>
      <variable name="BACKEND_URL">Same Railway API URL as Vercel uses</variable>
      <variable name="NEXT_PUBLIC_SENTRY_DSN">Sentry DSN</variable>
      <variable name="NODE_ENV">production</variable>
    </environment-variables>

    <cors-configuration>
      <file>apps/server/src/main.ts</file>
      <origins>
        <origin>https://your-app.vercel.app</origin>
        <origin>https://your-web.railway.app</origin>
        <origin>http://localhost:3000</origin>
        <origin pattern="exp://.*">Expo Go (future mobile)</origin>
      </origins>
    </cors-configuration>
  </technical-specifications>

  <implementation-tasks>
    <task id="1" name="Create Railway web service" manual="true">
      <steps>
        <step>Create new service in Railway project</step>
        <step>Configure to use apps/web/Dockerfile</step>
        <step>Set build context to monorepo root</step>
        <step>Configure health check endpoint</step>
      </steps>
    </task>

    <task id="2" name="Configure Railway web environment variables" manual="true">
      <steps>
        <step>Set NEXT_PUBLIC_SUPABASE_URL</step>
        <step>Set NEXT_PUBLIC_SUPABASE_ANON_KEY</step>
        <step>Set BACKEND_URL</step>
        <step>Set Sentry variables</step>
      </steps>
    </task>

    <task id="3" name="Update backend CORS" agent="true">
      <file>apps/server/src/main.ts</file>
      <steps>
        <step>Add Railway web URL to CORS origins</step>
        <step>Verify both Vercel and Railway origins work</step>
      </steps>
    </task>

    <task id="4" name="Update deployment workflows" agent="true">
      <steps>
        <step>Add Railway web deployment to staging workflow</step>
        <step>Add Railway web deployment to production workflow</step>
        <step>Verify both web deployments trigger correctly</step>
      </steps>
    </task>

    <task id="5" name="Test dual frontend access" manual="true">
      <steps>
        <step>Verify Vercel frontend → Railway API works</step>
        <step>Verify Railway frontend → Railway API works</step>
        <step>Verify both create records in same database</step>
      </steps>
    </task>
  </implementation-tasks>

  <references>
    <doc path="apps/web/Dockerfile">Web Dockerfile (from Story 5.3)</doc>
    <doc path="docs/architecture-decisions.md" section="Dual Frontend Strategy">Architecture decision</doc>
    <doc path="docs/epics.md" section="Story 5.9">Story definition</doc>
  </references>
</story-context>

