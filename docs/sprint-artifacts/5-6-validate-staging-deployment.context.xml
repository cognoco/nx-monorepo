<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context Document
  Generated: 2025-12-05
  Updated: 2025-12-09 (renumbered from 5-4 to 5-6)
  Story: 5-6-validate-staging-deployment
  Epic: 5 - CI/CD Staging & Production Deployment
-->
<story-context story-id="5-6" version="1.1">
  <metadata>
    <title>Validate Staging Deployment</title>
    <epic>Epic 5: CI/CD Staging & Production Deployment</epic>
    <status>drafted</status>
    <generated-date>2025-12-05</generated-date>
    <updated-date>2025-12-09</updated-date>
    <dependencies>
      <dependency story-id="5-2" status="done">Configure GitHub Actions Deployment Workflow</dependency>
      <dependency story-id="5-3" status="done">Configure Docker Containerization</dependency>
      <dependency story-id="5-5" status="done">Environment Infrastructure Alignment</dependency>
    </dependencies>
  </metadata>

  <story-summary>
    <user-story>
      As a stakeholder, I want to verify the staging environment works correctly,
      so that I can demo and validate features.
    </user-story>
    <acceptance-criteria>
      <criterion id="AC1">Application is deployed to staging URL within 10 minutes of PR/feature branch push (Vercel Preview + Railway staging)</criterion>
      <criterion id="AC2">Walking skeleton health check works (web /health page)</criterion>
      <criterion id="AC3">API health check endpoint responds correctly (/api/health)</criterion>
      <criterion id="AC4">Database connectivity verified (health check writes to database)</criterion>
      <criterion id="AC5">Observability captures staging events (if Epic 3 complete)</criterion>
      <criterion id="AC6">Staging URL is documented in README</criterion>
      <criterion id="AC7">Environment-specific configuration is correct (API URLs, etc.)</criterion>
    </acceptance-criteria>
  </story-summary>

  <architectural-context>
    <decision-reference doc="docs/architecture-decisions.md" section="Epic 5: CI/CD Staging Deployment">
      <summary>Two-target deployment strategy for staging validation</summary>
      <deployment-targets>
        <primary>
          <web platform="Vercel" url="TBD">Zero-config Next.js deployment</web>
          <api platform="Railway" url="TBD">Docker container, long-running process</api>
        </primary>
        <secondary note="If time permits">
          <web platform="Railway">Docker container</web>
          <api platform="Railway">Docker container</api>
        </secondary>
      </deployment-targets>
    </decision-reference>

    <environment-configuration>
      <database>Supabase STAGING project (uvhnqtzufwvaqvbdgcnn)</database>
      <purpose>Staging deployments and local integration tests</purpose>
      <rationale>CI uses local PostgreSQL for isolation; STAGING validates infrastructure</rationale>
      <note>Merges to main trigger PRODUCTION deployment (Story 5.7), not staging</note>
    </environment-configuration>
  </architectural-context>

  <technical-specifications>
    <validation-endpoints>
      <endpoint name="Web Health Page">
        <url>https://{staging-web-url}/health</url>
        <expected-behavior>
          <item>Displays health check list from database</item>
          <item>Shows "Ping" button for creating new health checks</item>
          <item>Demonstrates end-to-end connectivity: web → API → database</item>
        </expected-behavior>
      </endpoint>

      <endpoint name="API Health Check">
        <url>https://{staging-api-url}/api/health</url>
        <method>GET</method>
        <expected-response>
          <status>200 OK</status>
          <body>JSON with status, timestamp, database connectivity info</body>
        </expected-response>
      </endpoint>

      <endpoint name="API Health Ping">
        <url>https://{staging-api-url}/api/health</url>
        <method>POST</method>
        <expected-behavior>Creates new health check record in database</expected-behavior>
      </endpoint>
    </validation-endpoints>

    <environment-variables>
      <web-app>
        <variable name="NEXT_PUBLIC_API_URL">Must point to Railway staging API URL</variable>
        <variable name="NEXT_PUBLIC_SUPABASE_URL">Supabase TEST project URL</variable>
        <variable name="NEXT_PUBLIC_SUPABASE_ANON_KEY">Supabase TEST anon key</variable>
      </web-app>
      <api-server>
        <variable name="DATABASE_URL">Supabase TEST pooler connection (port 6543)</variable>
        <variable name="DIRECT_URL">Supabase TEST direct connection (port 5432)</variable>
        <variable name="SUPABASE_URL">Supabase TEST project URL</variable>
        <variable name="NODE_ENV">production</variable>
        <variable name="PORT">4000 (or platform-assigned)</variable>
      </api-server>
    </environment-variables>

    <mobile-compatibility>
      <requirements>
        <item>HTTPS with valid SSL certificate (auto-provided by Vercel/Railway)</item>
        <item>Stable public URLs (not ephemeral preview URLs for primary staging)</item>
        <item>No cold starts for API (Railway provides this)</item>
        <item>CORS configured for Expo Go and mobile origins</item>
      </requirements>
      <cors-origins note="Configured in apps/server/src/main.ts">
        <origin>https://{staging-web-url}</origin>
        <origin>http://localhost:3000</origin>
        <origin pattern="exp://.*">Expo Go development</origin>
      </cors-origins>
    </mobile-compatibility>
  </technical-specifications>

  <validation-procedures>
    <procedure id="1" name="Deployment Timing Validation">
      <description>Verify deployment completes within 10 minutes of merge</description>
      <steps>
        <step>Note timestamp when PR is merged to main</step>
        <step>Monitor GitHub Actions deployment workflow</step>
        <step>Note timestamp when deployment completes (both web and API)</step>
        <step>Verify total time is under 10 minutes</step>
      </steps>
      <success-criteria>Deployment completes within 10 minutes</success-criteria>
    </procedure>

    <procedure id="2" name="Web Health Page Validation">
      <description>Verify web application is accessible and functional</description>
      <steps>
        <step>Navigate to staging web URL /health page</step>
        <step>Verify page loads without errors</step>
        <step>Verify health check list is displayed (may be empty initially)</step>
        <step>Click "Ping" button to create new health check</step>
        <step>Verify new health check appears in list</step>
        <step>Refresh page and verify data persists</step>
      </steps>
      <success-criteria>Walking skeleton health check feature works end-to-end</success-criteria>
    </procedure>

    <procedure id="3" name="API Health Check Validation">
      <description>Verify API server is accessible and responding</description>
      <steps>
        <step>curl https://{staging-api-url}/api/health</step>
        <step>Verify 200 OK response</step>
        <step>Verify JSON response includes status, timestamp</step>
        <step>Verify database connectivity indicator (if included in response)</step>
      </steps>
      <success-criteria>API health check returns valid response</success-criteria>
      <command>curl -s https://{staging-api-url}/api/health | jq .</command>
    </procedure>

    <procedure id="4" name="Database Connectivity Validation">
      <description>Verify API can read/write to Supabase TEST database</description>
      <steps>
        <step>POST to /api/health to create new record</step>
        <step>GET /api/health to retrieve records</step>
        <step>Verify new record appears in response</step>
        <step>Optional: Check Supabase dashboard to see record in health_checks table</step>
      </steps>
      <success-criteria>Database operations work from staging environment</success-criteria>
      <commands>
        <command purpose="Create health check">
          curl -X POST https://{staging-api-url}/api/health
        </command>
        <command purpose="Retrieve health checks">
          curl https://{staging-api-url}/api/health
        </command>
      </commands>
    </procedure>

    <procedure id="5" name="Environment Configuration Validation">
      <description>Verify environment-specific settings are correct</description>
      <steps>
        <step>Inspect web app network requests (browser DevTools)</step>
        <step>Verify API calls go to correct staging API URL (not localhost)</step>
        <step>Verify no hardcoded development URLs</step>
        <step>Check for CORS errors (should be none)</step>
      </steps>
      <success-criteria>All environment variables correctly configured for staging</success-criteria>
    </procedure>

    <procedure id="6" name="Cross-Platform Verification" optional="true">
      <description>Verify web and API work together across platforms</description>
      <steps>
        <step>Create health check via web UI</step>
        <step>Verify via direct API call that record exists</step>
        <step>Create health check via API</step>
        <step>Refresh web UI and verify record appears</step>
      </steps>
      <success-criteria>Data synchronization works across entry points</success-criteria>
    </procedure>

    <procedure id="7" name="Observability Validation" conditional="Epic 3 complete">
      <description>Verify Sentry captures staging events</description>
      <steps>
        <step>Trigger intentional error (if test endpoint exists)</step>
        <step>Check Sentry dashboard for staging environment</step>
        <step>Verify error appears with correct environment tag</step>
        <step>Verify performance transactions are being recorded</step>
      </steps>
      <success-criteria>Observability captures staging events</success-criteria>
      <note>Skip if Epic 3 (Observability Baseline) not yet complete</note>
    </procedure>
  </validation-procedures>

  <documentation-requirements>
    <readme-updates>
      <item>Add "Staging Environment" section to README.md</item>
      <item>Document staging web URL</item>
      <item>Document staging API URL</item>
      <item>Note that staging uses Supabase TEST project</item>
      <item>Add deployment status badge (optional)</item>
    </readme-updates>

    <validation-evidence>
      <item>Screenshot of successful deployment in GitHub Actions</item>
      <item>Screenshot of working /health page</item>
      <item>API health check response (terminal output or screenshot)</item>
      <item>Note any staging-specific quirks or limitations</item>
    </validation-evidence>
  </documentation-requirements>

  <validation-checklist>
    <section name="Deployment">
      <item id="V1">Merge to main triggers deployment workflow</item>
      <item id="V2">Deployment completes within 10 minutes</item>
      <item id="V3">Both web and API deployments succeed</item>
      <item id="V4">GitHub Actions shows green status</item>
    </section>

    <section name="Web Application">
      <item id="V5">Staging web URL is accessible via HTTPS</item>
      <item id="V6">/health page loads without errors</item>
      <item id="V7">Health check list displays</item>
      <item id="V8">"Ping" button creates new health check</item>
      <item id="V9">Data persists after page refresh</item>
    </section>

    <section name="API Server">
      <item id="V10">Staging API URL is accessible via HTTPS</item>
      <item id="V11">/api/health returns 200 OK</item>
      <item id="V12">Response includes valid JSON</item>
      <item id="V13">POST /api/health creates record</item>
    </section>

    <section name="Database">
      <item id="V14">API connects to Supabase TEST project</item>
      <item id="V15">Read operations work</item>
      <item id="V16">Write operations work</item>
      <item id="V17">Data visible in Supabase dashboard</item>
    </section>

    <section name="Configuration">
      <item id="V18">NEXT_PUBLIC_API_URL correctly set</item>
      <item id="V19">No CORS errors in browser console</item>
      <item id="V20">No hardcoded localhost URLs</item>
    </section>

    <section name="Documentation">
      <item id="V21">README.md updated with staging URLs</item>
      <item id="V22">Deployment badge added (optional)</item>
      <item id="V23">Any staging quirks documented</item>
    </section>

    <section name="Observability" conditional="Epic 3">
      <item id="V24">Sentry receives staging events</item>
      <item id="V25">Environment correctly tagged as "staging"</item>
    </section>
  </validation-checklist>

  <known-limitations>
    <limitation id="1">
      <title>Shared Database with CI</title>
      <description>Staging and CI both use Supabase TEST project</description>
      <impact>CI test data may appear in staging; this is acceptable for Phase 1</impact>
      <mitigation>Consider separate staging database in Phase 2 if needed</mitigation>
    </limitation>

    <limitation id="2">
      <title>No Preview Deployments for API</title>
      <description>Railway doesn't provide preview deployments like Vercel</description>
      <impact>API changes go directly to staging when merged to main</impact>
      <mitigation>Thorough testing before merge; rollback if issues</mitigation>
    </limitation>

    <limitation id="3">
      <title>Build Time Dependencies</title>
      <description>Web app environment variables baked in at build time</description>
      <impact>Changing API URL requires rebuild, not just restart</impact>
      <mitigation>Document this behavior; plan environment variable changes carefully</mitigation>
    </limitation>
  </known-limitations>

  <implementation-guidance>
    <prerequisites>
      <item>Story 5-2 complete (GitHub Actions deployment workflow)</item>
      <item>Story 5-3 complete (Docker containerization)</item>
      <item>Vercel and Railway accounts configured</item>
      <item>GitHub secrets configured for deployment</item>
    </prerequisites>

    <execution-approach>
      <step order="1">Trigger deployment by merging a change to main</step>
      <step order="2">Monitor GitHub Actions for deployment completion</step>
      <step order="3">Execute validation procedures in order</step>
      <step order="4">Document results and any issues</step>
      <step order="5">Update README with staging URLs</step>
      <step order="6">Mark story as complete after all validations pass</step>
    </execution-approach>

    <troubleshooting>
      <issue name="Deployment Timeout">
        <symptoms>GitHub Actions workflow exceeds 10 minutes</symptoms>
        <diagnosis>Check build logs for slow steps (npm install, Docker build)</diagnosis>
        <solutions>
          <solution>Enable Nx Cloud caching for faster builds</solution>
          <solution>Optimize Docker layer caching</solution>
        </solutions>
      </issue>

      <issue name="CORS Errors">
        <symptoms>Browser console shows CORS blocked errors</symptoms>
        <diagnosis>Check API server CORS configuration</diagnosis>
        <solutions>
          <solution>Add staging web URL to CORS origins in apps/server/src/main.ts</solution>
          <solution>Verify CORS middleware is applied before routes</solution>
        </solutions>
      </issue>

      <issue name="Database Connection Failed">
        <symptoms>API returns 500 errors, database operations fail</symptoms>
        <diagnosis>Check DATABASE_URL environment variable in Railway</diagnosis>
        <solutions>
          <solution>Verify Supabase TEST credentials are correct</solution>
          <solution>Check Supabase connection limits not exceeded</solution>
          <solution>Verify IP allowlist (if configured)</solution>
        </solutions>
      </issue>

      <issue name="Wrong API URL">
        <symptoms>Web app calls localhost or wrong URL</symptoms>
        <diagnosis>Check NEXT_PUBLIC_API_URL in Vercel environment</diagnosis>
        <solutions>
          <solution>Update Vercel environment variable</solution>
          <solution>Redeploy web app (environment variables are build-time)</solution>
        </solutions>
      </issue>
    </troubleshooting>
  </implementation-guidance>

  <references>
    <doc path="docs/architecture-decisions.md" section="Epic 5">Deployment platform decisions</doc>
    <doc path="docs/epics.md" section="Story 5.6">Story definition and acceptance criteria</doc>
    <doc path="docs/environment-strategy.md">Environment architecture and CI database strategy</doc>
    <doc path="docs/environment-variables-matrix.md">Environment variable traceability</doc>
    <doc path=".github/workflows/deploy-staging.yml" note="Created in Story 5-2">Deployment workflow</doc>
    <doc path="apps/server/src/routes/health.ts">Health check endpoint implementation</doc>
    <doc path="apps/web/src/app/health/page.tsx">Health page implementation</doc>
  </references>
</story-context>
