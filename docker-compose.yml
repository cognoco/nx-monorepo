# =============================================================================
# Docker Compose - Local Development and Testing
# =============================================================================
# This file enables running the full stack locally in containers.
# Useful for: testing Docker builds, validating production-like environment,
# debugging container networking issues.
#
# Note: For daily development, use `pnpm run dev` which is faster.
# Use Docker Compose when you need to validate containerized deployment.
# =============================================================================
# Usage:
#   Build:  docker compose build
#   Start:  docker compose up
#   Stop:   docker compose down
#   Logs:   docker compose logs -f [service]
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Server - Express API
  # ---------------------------------------------------------------------------
  server:
    build:
      context: .
      dockerfile: apps/server/Dockerfile
    container_name: nx-monorepo-server
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - HOST=0.0.0.0
      # Database connection - loaded from .env.docker file
      - DATABASE_URL=${DATABASE_URL}
      # Supabase configuration
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # Sentry (optional - leave empty to disable)
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-docker}
    healthcheck:
      # Note: Use 127.0.0.1 instead of localhost to avoid IPv6 resolution issues in Alpine
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:4000/api/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

  # ---------------------------------------------------------------------------
  # Web - Next.js Application
  # ---------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        # Build-time environment variables (baked into client bundle)
        # In Docker Compose, we point to the server container
        - NEXT_PUBLIC_API_URL=http://server:4000
        - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    container_name: nx-monorepo-web
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      # Sentry (optional)
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-docker}
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      # Note: Use 127.0.0.1 instead of localhost to avoid IPv6 resolution issues in Alpine
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

# =============================================================================
# Networks
# =============================================================================
networks:
  app-network:
    driver: bridge
    name: nx-monorepo-network
